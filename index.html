<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>K-Pop Release Calendar — with external JSON</title>
  <style>
    :root{
      --bg:#071021; --muted:#9aa6b2; --text:#eef6fb; --accent:#e1508a;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    html,body{height:100%; margin:0; background:linear-gradient(180deg,#04101a,#071021); color:var(--text);}
    .wrap{max-width:980px;margin:20px auto;padding:18px;}
    .app{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px;border-radius:12px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 8px 40px rgba(2,6,23,0.6);}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;}
    h1{margin:0;font-size:18px;}
    .controls{display:flex;gap:8px;align-items:center;}
    select,input[type="file"],button{background:rgba(255,255,255,0.02); color:var(--text); border:1px solid rgba(255,255,255,0.04); padding:8px;border-radius:8px;font-size:13px;}
    button{cursor:pointer;}
    .calendar-wrap{display:grid;grid-template-columns:1fr 360px;gap:14px;}
    .calendar{padding:12px;border-radius:10px;}
    .month-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;color:var(--muted);font-size:12px;margin-bottom:6px;text-transform:uppercase;}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
    .day{background:rgba(255,255,255,0.01);min-height:74px;padding:8px;border-radius:8px;position:relative;overflow:hidden;border:1px solid transparent;cursor:pointer;}
    .day.inactive{opacity:0.26; cursor:default;}
    .day .num{font-size:13px;font-weight:700;}
    .marker{width:8px;height:8px;border-radius:50%;background:#ffdd57;position:absolute;right:8px;top:8px;}
    .day.today{outline:2px solid rgba(225,80,138,0.14);box-shadow:0 6px 18px rgba(225,80,138,0.06);border-color:rgba(225,80,138,0.12);}
    .songs{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.1;max-height:42px;overflow:auto;}
    .panel{padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:8px;height:100%;}
    .song{background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,0.02);}
    .song .left{min-width:46px;font-weight:700;font-size:12px;text-align:center;}
    .song .title{font-weight:700;}
    .meta{color:var(--muted);font-size:13px;}
    .hint{color:var(--muted);font-size:12px;margin-top:auto;}
    a { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    @media(max-width:920px){.calendar-wrap{grid-template-columns:1fr;} .panel{order:2;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application" aria-label="K-Pop calendar">
      <header>
        <div>
          <h1>K-Pop Release Calendar</h1>
          <div class="meta">Načte automaticky <code>kpop_songs.json</code> (pokud je ve stejné složce). Import a Export podporovány.</div>
        </div>

        <div class="controls">
          <select id="genSelect" title="Vyber generaci">
            <option value="all">Všechny generace</option>
            <option value="1">1. gen (cca 1992–2003)</option>
            <option value="2" selected>2. gen (cca 2004–2012)</option>
            <option value="3">3. gen (cca 2013–2017)</option>
            <option value="4">4. gen (cca 2018–2022)</option>
            <option value="5">5. gen (2023+)</option>
          </select>

          <input id="fileInput" type="file" accept=".json" title="Import JSON (pole objektů)" />
          <button id="exportBtn" title="Export aktuální databáze">Export DB</button>
          <button id="todayBtn" title="Přejít na aktuální měsíc">Dnes</button>
        </div>
      </header>

      <main class="calendar-wrap">
        <section class="calendar" aria-label="Kalendář">
          <div class="month-row">
            <button id="prev" aria-label="Předchozí měsíc">◀</button>
            <div id="monthLabel" aria-live="polite" aria-atomic="true">—</div>
            <button id="next" aria-label="Následující měsíc">▶</button>
          </div>

          <div class="weekdays" aria-hidden="true">
            <div>Po</div><div>Út</div><div>St</div><div>Čt</div><div>Pá</div><div>So</div><div>Ne</div>
          </div>

          <div class="grid" id="grid" role="grid" aria-label="Dny v měsíci"></div>
        </section>

        <aside class="panel" aria-label="Seznam písní">
          <h2 id="panelTitle">Vyber den</h2>
          <div class="meta" id="panelMeta">Vyber datum v kalendáři vlevo.</div>
          <div id="songList" role="list"></div>
          <div class="hint">Formát JSON položky: <code>{ "title", "artist", "release_date": "YYYY-MM-DD", "generation": n, "youtube": "URL", "spotify": "URL" }</code></div>
        </aside>
      </main>
    </div>
  </div>

  <script>
    // Vestavěné demo, pokud není externí JSON dostupný
    let songs = [
      { title:"G.N.O.", artist:"Wonder Girls", release_date:"2011-11-07", generation:2, youtube:"https://youtu.be/ttJpY9pmSO8" },
      { title:"Gee", artist:"Girls' Generation", release_date:"2009-01-05", generation:2, youtube:"https://youtu.be/U7mPqycQ0tQ" },
      { title:"Like OOH-AHH", artist:"TWICE", release_date:"2015-10-20", generation:3, youtube:"https://youtu.be/0rtV5esQT6I" }
    ];

    // Pokus načíst externí JSON soubor kpop_songs.json (pokud existuje)
    fetch("kpop_songs.json")
      .then(r => {
        if (!r.ok) throw new Error("Nenalezen kpop_songs.json");
        return r.json();
      })
      .then(arr => {
        if (Array.isArray(arr) && arr.length > 0) {
          // Přidáme externí data před vestavěná, aby externí byla priorita
          songs = arr.concat(songs);
          buildMapFromArray(songs);
          renderCalendar(viewDate);
        }
      })
      .catch(() => {
        // Pokud načtení selže, použijeme vestavěná data
        buildMapFromArray(songs);
        renderCalendar(viewDate);
      });

    // Mapování podle měsíce-den, pro rychlé hledání
    const mdMap = new Map();
    function buildMapFromArray(arr){
      mdMap.clear();
      for (const s of arr){
        if (!s.release_date) continue;
        const [y,m,d] = s.release_date.split("-").map(Number);
        if (!m || !d) continue;
        const key = `${m}-${d}`;
        if (!mdMap.has(key)) mdMap.set(key, []);
        mdMap.get(key).push(s);
      }
    }

    // Stav a UI reference
    let viewDate = new Date();
    const monthNames = ["Leden","Únor","Březen","Duben","Květen","Červen","Červenec","Srpen","Září","Říjen","Listopad","Prosinec"];
    const monthLabel = document.getElementById("monthLabel");
    const grid = document.getElementById("grid");
    const panelTitle = document.getElementById("panelTitle");
    const panelMeta = document.getElementById("panelMeta");
    const songList = document.getElementById("songList");
    const genSelect = document.getElementById("genSelect");
    const todayBtn = document.getElementById("todayBtn");

    // Vykreslení kalendáře pro zvolený měsíc a rok
    function renderCalendar(date){
      grid.innerHTML = "";
      const y = date.getFullYear();
      const m = date.getMonth();
      monthLabel.textContent = monthNames[m] + " " + y;

      const first = new Date(y, m, 1);
      // Přepočet dne v týdnu (Po = 0)
      const firstWeekday = (first.getDay() + 6) % 7;
      const daysInMonth = new Date(y, m+1, 0).getDate();
      const prevBlanks = firstWeekday;
      const totalSlots = Math.ceil((prevBlanks + daysInMonth) / 7) * 7;
      const genFilter = genSelect.value;

      const today = new Date();
      const todayKey = `${today.getMonth()+1}-${today.getDate()}`;

      for (let i=0;i<totalSlots;i++){
        const el = document.createElement("div");
        el.className = "day";
        const dayNum = i - prevBlanks + 1;
        if (dayNum <= 0 || dayNum > daysInMonth){
          el.classList.add("inactive");
          const num = document.createElement("div"); num.className="num"; num.textContent = "";
          el.appendChild(num);
        } else {
          const num = document.createElement("div"); num.className="num"; num.textContent = dayNum;
          el.appendChild(num);
          const key = `${m+1}-${dayNum}`;
          const matches = mdMap.get(key) || [];
          // Filtrování podle generace
          const filtered = matches.filter(s => genFilter === "all" ? true : String(s.generation) === genFilter);

          if (filtered.length > 0){
            const marker = document.createElement("div"); marker.className="marker";
            el.appendChild(marker);
            const list = document.createElement("div"); list.className="songs";
            filtered.slice(0,3).forEach(s => {
              const r = document.createElement("div");
              r.textContent = `${s.title} — ${s.artist}`;
              if (s.youtube) {
                const a = document.createElement("a");
                a.href = s.youtube;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.style.color = "var(--accent)";
                a.style.marginLeft = "6px";
                a.textContent = "[YT]";
                r.appendChild(a);
              }
              list.appendChild(r);
            });
            if (filtered.length > 3){
              const more = document.createElement("div"); 
              more.textContent = `…a ${filtered.length-3} dalších`; 
              more.style.color="var(--muted)"; 
              more.style.fontSize="12px"; 
              list.appendChild(more);
            }
            el.appendChild(list);
          }

          if (key === todayKey && dayNum === today.getDate() && (m === today.getMonth() && y === today.getFullYear())){
            el.classList.add("today
